# 6. 인증/권한이 인터페이스에 드러나는 방식

[← 목차로 돌아가기](./0.목차.md) | [← 이전: 에러처리](./5.에러처리.md)

---

## 6.1 인증(Authentication) vs 인가(Authorization)

| 구분 | 인증 (Authentication) | 인가 (Authorization) |
|------|----------------------|---------------------|
| 질문 | "당신은 누구인가?" | "당신은 이걸 할 수 있는가?" |
| 수단 | SSO 로그인, 토큰 | 역할(Role), 권한(Permission) |
| 시점 | 최초 요청 시 | 매 요청마다 |

---

## 6.2 헤더를 통한 사용자 정보 전달

```
┌─────────────────────────────────────────────────────────────────┐
│                    헤더 패스스루 흐름                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [1] 사용자 로그인 (SSO)                                        │
│   ┌──────────────┐                                              │
│   │   Browser    │  SSO Token 획득                              │
│   └──────┬───────┘                                              │
│          │                                                      │
│          ▼                                                      │
│   [2] MCPHUB 요청                                                │
│   ┌──────────────┐                                              │
│   │   MCPHUB     │  SSO Token 검증 → 사용자 정보 추출           │
│   │              │  - user_id: "yeji.lee"                       │
│   │              │  - role: "DEVELOPER"                         │
│   │              │  - scopes: ["jira:read", "slack:write"]      │
│   └──────┬───────┘                                              │
│          │                                                      │
│          ▼                                                      │
│   [3] MCP 서버로 전달 (헤더 주입)                                │
│   ┌──────────────┐                                              │
│   │  MCP Server  │  수신 헤더:                                  │
│   │              │  - x-user-id: "yeji.lee"                     │
│   │              │  - x-user-role: "DEVELOPER"                  │
│   │              │  - Authorization: Bearer <token>             │
│   └──────────────┘                                              │
│                                                                 │
│   → MCP 서버는 헤더를 보고 "누가 호출했는지" 알 수 있음         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> 📌 **결정 필요**: MCPHUB에서 권한 체크를 **Pre-filter**(목록에서 미리 필터링)로 할 것인지, **Post-check**(실행 시점에 체크)로 할 것인지 결정이 필요합니다.

---

## 6.3 Internal vs External MCP 처리 분기

MCPHUB는 호출 대상에 따라 **Internal MCP**와 **External MCP**를 구분하여 처리합니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Internal / External MCP 처리 흐름                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────┐                                                               │
│   │ 사용자  │  SSO 로그인                                                   │
│   └────┬────┘                                                               │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────┐                                                      │
│   │  MCPHUB 서버호출  │                                                      │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            ▼                                                                │
│   ┌──────────────────┐                                                      │
│   │ 호출 서비스 구분  │                                                      │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│      ┌─────┴─────┐                                                          │
│      │           │                                                          │
│      ▼           ▼                                                          │
│ ┌─────────┐ ┌───────────┐                                                   │
│ │Internal │ │ External  │                                                   │
│ └────┬────┘ └─────┬─────┘                                                   │
│      │            │                                                         │
│      │            ▼                                                         │
│      │      ┌─────────────────┐                                             │
│      │      │ PersonalKey 확인 │                                             │
│      │      │ (MySpace 등록정보)│                                             │
│      │      └────────┬────────┘                                             │
│      │               │                                                      │
│      │         ┌─────┴─────┐                                                │
│      │         │           │                                                │
│      │         ▼           ▼                                                │
│      │    ┌────────┐  ┌────────┐                                            │
│      │    │ 확인됨  │  │ 미확인 │                                            │
│      │    └───┬────┘  └───┬────┘                                            │
│      │        │           │                                                 │
│      ▼        ▼           ▼                                                 │
│ ┌───────────────────┐  ┌────────────────┐                                   │
│ │ 내부 MCP 정보확인  │  │ 실행 불가 응답  │                                   │
│ │ → 실행 요청       │  │ (Key 등록 필요) │                                   │
│ └───────────────────┘  └────────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Internal vs External 비교

| 구분 | Internal MCP | External MCP |
|------|-------------|--------------|
| **대상** | 사내시스템, 사내 API | Jira, Slack, Google 등 외부시스템 |
| **인증** | SSO 인증만 | SSO 인증 + PersonalKey |
| **Key 관리** | 불필요 | MySpace에서 1회 등록 |
| **예시** | 메시지발송, 이력조회 | JIRA 이슈생성, Slack 메시지 |

---

## 6.4 External MCP와 Personal Key

Jira, Slack, Google 등 외부 서비스 연동 시 사용자별 API Key가 필요합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                  Personal Key 프록시 흐름                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [1] 사전 등록 (MySpace)                                        │
│   사용자가 MCPHUB MySpace에서 Jira API Token 등록                │
│   → DB에 암호화 저장: { user: "yeji.lee", jira_key: "xxx" }     │
│                                                                 │
│   [2] 실행 시 자동 주입                                          │
│   ┌──────────────┐                                              │
│   │   MCPHUB     │  사용자 식별 → DB에서 Personal Key 조회      │
│   │              │  헤더에 주입: x-personal-jira-key: xxx       │
│   └──────┬───────┘                                              │
│          │                                                      │
│          ▼                                                      │
│   ┌──────────────┐                                              │
│   │  Jira MCP    │  헤더에서 Key 추출 → Jira API 호출           │
│   └──────────────┘                                              │
│                                                                 │
│   [3] Key 없을 때 에러 처리                                      │
│   {                                                             │
│     "error": {                                                  │
│       "code": -32600,                                           │
│       "message": "Jira API Key가 등록되지 않았습니다",           │
│       "data": {                                                 │
│         "action": "register_key",                               │
│         "service": "jira",                                      │
│         "url": "/myspace/keys"                                  │
│       }                                                         │
│     }                                                           │
│   }                                                             │
│   → 프론트: "키 등록하기" 버튼 표시                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> 💡 **PersonalKey**는 사용자가 MCPHUB의 **MySpace**에서 1회 등록한 정보를 기반으로 검증합니다.  
> External MCP 실행 시 MCPHUB가 이 Key를 **비노출 중계**하여 보안을 유지합니다.

---

## 6.5 민감정보 승인 프로세스

민감정보(회원번호, 전화번호 등)를 포함하는 MCP 서버는 **상위결재자 승인 후**에만 접근 가능합니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       민감정보 포함 MCP 승인 Flow                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────┐                                                               │
│   │ 사용자  │  SSO 로그인                                                   │
│   └────┬────┘                                                               │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────┐                                                      │
│   │  MCPHUB 어드민   │  MCP 서버 사용 신청                                   │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            ▼                                                                │
│   ┌──────────────────┐                                                      │
│   │   사용 여부 확인  │                                                      │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│      ┌─────┴─────┐                                                          │
│      │           │                                                          │
│      ▼           ▼                                                          │
│ ┌─────────┐ ┌─────────┐                                                     │
│ │ 미사용  │ │  사용   │                                                     │
│ └────┬────┘ └────┬────┘                                                     │
│      │           │                                                          │
│      │           ▼                                                          │
│      │    ┌─────────────────┐                                               │
│      │    │ 민감정보 포함여부 │                                               │
│      │    └────────┬────────┘                                               │
│      │             │                                                        │
│      │       ┌─────┴─────┐                                                  │
│      │       │           │                                                  │
│      │       ▼           ▼                                                  │
│      │  ┌─────────┐ ┌─────────┐                                             │
│      │  │ 미포함  │ │  포함   │                                             │
│      │  └────┬────┘ └────┬────┘                                             │
│      │       │           │                                                  │
│      │       │           ▼                                                  │
│      │       │    ┌─────────────────┐                                       │
│      │       │    │ 사용 승인 요청   │                                       │
│      │       │    │ (상위결재자)    │                                       │
│      │       │    └────────┬────────┘                                       │
│      │       │             │                                                │
│      │       │       ┌─────┴─────┐                                          │
│      │       │       │           │                                          │
│      ▼       │       ▼           ▼                                          │
│ ┌────────────┴───────────┐  ┌────────────────┐                              │
│ │ MCP 서버 활성화         │  │ 호출 서버에서   │                              │
│ │ → MCPHUB에서 호출 가능  │  │ 제외 (미승인)   │                              │
│ └────────────────────────┘  └────────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

> ⚠️ **참고**: MCPHUB에 등록된 MCP 서버는 기본적으로 모두 사용할 수 있으나,  
> 민감정보를 포함한 서버는 **상위결재자의 승인 후** 접근 가능합니다.

### 민감정보 입출력 마스킹

MCPHUB는 요청과 응답 양방향에서 민감정보를 마스킹합니다.

| 시점 | 마스킹 대상 | 예시 |
|------|-----------|------|
| **요청 시** | 입력 파라미터의 민감정보 | 주민번호, 카드번호 입력 시 로그 마스킹 |
| **응답 시** | 출력 결과의 민감정보 | 전화번호 `010-****-5678`, 이메일 `ye***@company.com` |

> 📌 **결정 필요**: 프롬프트 인젝션(Confused Deputy) 방어를 위해 파괴적 액션(DELETE 등)에 대한 **Human-in-the-loop 강제화 정책**을 MCPHUB에서 어떻게 적용할지 결정이 필요합니다.

---

[다음: 운영 →](./7.운영.md)
