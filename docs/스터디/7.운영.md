# 7. MCPHUB 운영: 헬스체크, 상태관리, 로깅

[← 목차로 돌아가기](./0.목차.md) | [← 이전: 인증권한](./6.인증권한.md)

---

## 7.1 헬스체크 (Health Check)

MCP 서버가 정상 동작하는지 확인하는 메커니즘입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    헬스체크 시점과 방법                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [1] 등록 시 검증 (Registration Health Check)                   │
│   ───────────────────────────────────────────────────────────   │
│   Provider가 MCP 서버 등록 시:                                   │
│   1. initialize 호출 → 서버 응답 확인                           │
│   2. tools/list 호출 → 도구 목록 정상 반환 확인                 │
│   3. 실패 시 등록 차단 + 에러 메시지 표시                        │
│                                                                 │
│   [2] 주기적 헬스체크 (Periodic Health Check)                    │
│   ───────────────────────────────────────────────────────────   │
│   등록된 서버를 주기적으로(예: 5분마다) 확인:                    │
│   - /health 엔드포인트 호출 (HTTP 기반 서버)                     │
│   - 또는 ping/pong 메시지 교환                                  │
│                                                                 │
│   [3] 실패 처리 정책                                             │
│   ───────────────────────────────────────────────────────────   │
│   연속 실패 횟수에 따른 상태 변경:                               │
│   - 1~2회 실패: 경고 로그 기록                                   │
│   - 3회 연속 실패: 상태를 "Unhealthy"로 변경                     │
│   - 자동 복구: 다시 정상 응답 시 "Active"로 복원                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7.2 서버 상태 관리

```
┌─────────────────────────────────────────────────────────────────┐
│                    MCP 서버 상태 전이도                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                     ┌──────────┐                                │
│                     │  Draft   │  (임시저장)                     │
│                     └────┬─────┘                                │
│                          │ 등록 + 헬스체크 성공                  │
│                          ▼                                      │
│   ┌──────────────────────────────────────────────┐              │
│   │                  Active                      │              │
│   │  (정상 서비스 중)                            │              │
│   └───────┬──────────────────────────┬───────────┘              │
│           │                          │                          │
│           │ 헬스체크 3회 실패        │ Provider가 비활성화       │
│           ▼                          ▼                          │
│   ┌──────────────┐          ┌──────────────┐                    │
│   │  Unhealthy   │          │   Inactive   │                    │
│   │  (장애 감지)  │          │  (수동 비활성화) │                 │
│   └───────┬──────┘          └───────┬──────┘                    │
│           │                          │                          │
│           │ 헬스체크 성공            │ Provider가 활성화         │
│           └───────────┬──────────────┘                          │
│                       │                                         │
│                       ▼                                         │
│                  [Active로 복원]                                 │
│                                                                 │
│   ※ 상태별 동작:                                                │
│   - Active: 정상 호출 가능                                       │
│   - Inactive: 호출 시 "서버 비활성화" 에러 반환                  │
│   - Unhealthy: 호출 시 "서버 응답 불가" 에러 반환               │
│   - Draft: 호출 불가, 등록자만 편집 가능                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7.3 로깅 전략

```
┌─────────────────────────────────────────────────────────────────┐
│                    로깅 수집 항목                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [요청 로그]                                                    │
│   ───────────────────────────────────────────────────────────   │
│   {                                                             │
│     "timestamp": "2026-01-13T10:30:00Z",                        │
│     "request_id": "req-abc123",                                 │
│     "user_id": "yeji.lee",                                      │
│     "method": "tools/call",                                     │
│     "tool_name": "create_jira_issue",                           │
│     "mcp_server": "jira-mcp",                                   │
│     "params_hash": "sha256:...",  // 파라미터 해시 (민감정보 보호) │
│     "ip": "10.0.0.1"                                            │
│   }                                                             │
│                                                                 │
│   [응답 로그]                                                    │
│   ───────────────────────────────────────────────────────────   │
│   {                                                             │
│     "request_id": "req-abc123",                                 │
│     "status": "success",  // 또는 "error"                       │
│     "duration_ms": 342,                                         │
│     "error_code": null,   // 에러 시 코드                       │
│     "response_size_bytes": 1024                                 │
│   }                                                             │
│                                                                 │
│   [보존 정책]                                                    │
│   - 실행 로그: 기본 3일 보관 후 폐기                            │
│   - 에러 로그: 7일 보관                                          │
│   - 감사 로그 (보안 관련): 1년 보관                              │
│                                                                 │
│   [활용]                                                         │
│   - 장애 분석: 특정 시간대 에러 급증 원인 파악                   │
│   - 사용량 분석: 인기 도구, 활성 사용자 통계                    │
│   - 보안 감사: 비정상 접근 패턴 탐지                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7.4 모니터링 대시보드 지표

| 지표 | 설명 | 임계값 예시 |
|------|------|-------------|
| **요청 수** | 분당 총 요청 수 | - |
| **에러율** | 전체 요청 대비 에러 비율 | > 5% 경고 |
| **평균 응답시간** | 요청~응답 평균 시간 | > 3초 경고 |
| **P99 응답시간** | 상위 1% 요청의 응답시간 | > 10초 경고 |
| **활성 MCP 서버** | Active 상태 서버 수 | - |
| **Unhealthy 서버** | 장애 감지된 서버 수 | > 0 즉시 알림 |

> 📌 **결정 필요**: MCPHUB는 단일 진입점(SPOF)이므로 **고가용성(HA) 구성**이 필요합니다. 다중 인스턴스, 로드 밸런서, 세션 외부화(Redis 등) 방안에 대한 결정이 필요합니다.

---

[다음: 동기비동기 →](./8.동기비동기.md)
