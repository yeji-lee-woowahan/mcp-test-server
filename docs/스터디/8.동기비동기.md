# 8. 동기/비동기 실행 모델 고려사항

[← 목차로 돌아가기](./0.목차.md) | [← 이전: 운영](./7.운영.md)

---

## 8.1 동기 vs 비동기 차이

```
┌─────────────────────────────────────────────────────────────────┐
│                    실행 모델 비교                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [동기 (Synchronous)]                                          │
│   ───────────────────────────────────────────────────────────   │
│   Client ──요청──> Hub ──요청──> MCP Server                     │
│     │                              │                            │
│     │         (대기)               │  (작업 수행)               │
│     │                              │                            │
│   Client <──응답── Hub <──응답── MCP Server                     │
│                                                                 │
│   - 요청 후 응답 올 때까지 대기                                  │
│   - 단순하고 직관적                                              │
│   - 긴 작업 시 타임아웃 문제                                    │
│                                                                 │
│   [비동기 (Asynchronous)]                                        │
│   ───────────────────────────────────────────────────────────   │
│   Client ──요청──> Hub ──요청──> MCP Server                     │
│     │                              │                            │
│   Client <──수락── Hub            │  (백그라운드 작업)          │
│     │              │               │                            │
│     │              │   <──진행상황 스트리밍──                   │
│     │              │               │                            │
│   Client <──완료 알림── Hub <──완료── MCP Server                │
│                                                                 │
│   - 요청 후 즉시 "작업 시작됨" 응답                              │
│   - 긴 작업에 적합                                               │
│   - 구현 복잡, 상태 관리 필요                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8.2 타임아웃 정책

```
┌─────────────────────────────────────────────────────────────────┐
│                    타임아웃 레이어                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────────────────────────────────────────────────┐     │
│   │               클라이언트 타임아웃 (30초)              │     │
│   │  ┌───────────────────────────────────────────────┐    │     │
│   │  │           MCPHUB 타임아웃 (25초)              │    │     │
│   │  │  ┌───────────────────────────────────────┐    │    │     │
│   │  │  │       MCP 서버 타임아웃 (20초)        │    │    │     │
│   │  │  │  ┌───────────────────────────────┐    │    │    │     │
│   │  │  │  │   외부 API 타임아웃 (10초)    │    │    │    │     │
│   │  │  │  └───────────────────────────────┘    │    │    │     │
│   │  │  └───────────────────────────────────────┘    │    │     │
│   │  └───────────────────────────────────────────────┘    │     │
│   └───────────────────────────────────────────────────────┘     │
│                                                                 │
│   ※ 각 레이어는 안쪽 레이어보다 타임아웃이 길어야 함            │
│      (그래야 안쪽에서 발생한 타임아웃 에러를 전파 가능)         │
│                                                                 │
│   ※ 타임아웃 발생 시:                                           │
│   - MCP 서버에 취소 신호 전달 필요                              │
│   - 클라이언트에 명확한 에러 메시지 전달                        │
│   - 로그에 타임아웃 원인 기록                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

> 📌 **결정 필요**: SSE 스트리밍 지원 시 **Connection Storm (Thundering Herd)** 방지를 위한 재접속 정책(Jitter 등)과 프록시 버퍼링 설정에 대한 결정이 필요합니다.

---

## 8.3 Rate Limiting

MCPHUB에서는 과부하 방지를 위해 Rate Limit을 적용합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    Rate Limit 적용 레벨                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [1] 전역 (Global)                                             │
│   ───────────────────────────────────────────────────────────   │
│   MCPHUB 전체에 대한 총 요청 제한                               │
│   예: 초당 N 요청                                               │
│                                                                 │
│   [2] 사용자별 (Per User)                                       │
│   ───────────────────────────────────────────────────────────   │
│   사용자(user_id) 기준 요청 제한                                │
│   예: 분당 N 요청                                               │
│                                                                 │
│   [3] MCP 서버별 (Per Server)                                   │
│   ───────────────────────────────────────────────────────────   │
│   특정 MCP 서버에 대한 요청 제한 (서버 과부하 방지)             │
│   예: 초당 N 요청                                               │
│                                                                 │
│   [Rate Limit 초과 시 응답]                                      │
│   {                                                             │
│     "error": {                                                  │
│       "code": -32000,                                           │
│       "message": "요청 한도 초과",                               │
│       "data": { "retry_after_seconds": 60 }                     │
│     }                                                           │
│   }                                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```


---

## 8.4 기타 고려사항

| 고려사항 | 설명 |
|---------|------|
| **Connection Pool** | MCP 서버별 커넥션 풀 관리 |
| **요청 격리** | 사용자 간 요청이 서로 영향을 주지 않도록 |
| **큐잉** | 무거운 작업은 큐에 넣고 순차 처리 |

> 📌 **검토 필요**: Connection Pool 설정, 요청 **취소(Cancellation)** 처리, **Latency 최적화** 전략(Passthrough, 비동기 로깅 등)의 적용 여부 검토가 필요합니다.

---

[다음: 체크리스트 →](./9.체크리스트.md)
