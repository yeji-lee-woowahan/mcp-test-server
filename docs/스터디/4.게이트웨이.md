# 4. MCPHUB의 역할: 게이트웨이

[← 목차로 돌아가기](./0.목차.md) | [← 이전: 통신](./3.통신.md)

---

## 4.1 왜 게이트웨이가 필요한가?

개별 MCP 서버에 직접 연결하면:
- ❌ 각 서버마다 인증 방식이 다름
- ❌ 서버 목록 관리가 분산됨
- ❌ 로깅, 모니터링이 개별적으로 필요
- ❌ 보안 정책 일관성 없음
- ❌ Rate Limit 등 트래픽 제어 불가

MCPHUB 게이트웨이를 두면:
- ✅ 단일 진입점으로 인증/인가 통합
- ✅ 모든 MCP 서버를 중앙에서 관리
- ✅ 통합 로깅, 모니터링
- ✅ 일관된 보안 정책 적용
- ✅ Rate Limit, 트래픽 제어 가능

---

## 4.2 게이트웨이 요청/응답 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MCPHUB 게이트웨이 요청/응답 흐름                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [1. 사용자 요청]                                                          │
│   ┌─────────┐                                                               │
│   │  User   │  "Jira에서 내 이슈 목록 보여줘"                                │
│   └────┬────┘                                                               │
│        │                                                                    │
│        ▼                                                                    │
│   [2. AI가 도구 호출 결정]                                                   │
│   ┌──────────────┐                                                          │
│   │   AI (LLM)   │  → tools/call: jira_get_issues                          │
│   └───────┬──────┘                                                          │
│           │                                                                 │
│           ▼                                                                 │
│   [3. MCPHUB 게이트웨이 - 요청 처리]                                         │
│   ┌──────────────────────────────────────────────────────────┐              │
│   │                      MCPHUB                              │              │
│   │                                                          │              │
│   │  (a) 인증/인가 확인           → 상세: 6.인증권한         │              │
│   │      - SSO 토큰 검증, 사용자 식별                        │              │
│   │      - 도구 사용 권한 확인                               │              │
│   │      - Internal/External 분기 및 PersonalKey 확인        │              │
│   │      - 민감정보 MCP 승인 여부 확인                       │              │
│   │                                                          │              │
│   │  (b) 서버 상태 확인           → 상세: 7.운영             │              │
│   │      - Active/Inactive/공개 상태 확인                    │              │
│   │      - 헬스체크 통과 여부                                │              │
│   │                                                          │              │
│   │  (c) Rate Limit 확인          → 상세: 8.동기비동기       │              │
│   │      - 사용자별/도구별 호출 제한 확인                    │              │
│   │                                                          │              │
│   │  (d) 요청 전처리 및 라우팅                               │              │
│   │      - 헤더 주입 (x-user-id, x-user-role, PersonalKey)   │              │
│   │      - 네임스페이스 접두어 제거 후 해당 서버로 전달      │              │
│   │                                                          │              │
│   │  (e) 로깅                     → 상세: 7.운영             │              │
│   │      - 요청/응답 기록                                    │              │
│   │                                                          │              │
│   └───────────────────────────┬──────────────────────────────┘              │
│                               │                                             │
│                               ▼                                             │
│   [4. MCP 서버로 전달]                                                       │
│   ┌──────────────────┐                                                      │
│   │   Jira MCP 서버   │  → 실제 Jira API 호출                               │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            ▼                                                                │
│   [5. 응답 처리]                                                             │
│   ┌──────────────────────────────────────────────────────────┐              │
│   │                      MCPHUB                              │              │
│   │  - 민감정보 마스킹 (필요시)                              │              │
│   │  - 에러 구조 유지 (꿀꺽 금지)   → 상세: 5.에러처리       │              │
│   │  - 응답 로깅                                             │              │
│   └───────────────────────────┬──────────────────────────────┘              │
│                               │                                             │
│                               ▼                                             │
│   [6. 클라이언트로 응답]                                                     │
│   ┌──────────────┐                                                          │
│   │   AI (LLM)   │  → 결과 해석                                             │
│   └───────┬──────┘                                                          │
│           │                                                                 │
│           ▼                                                                 │
│   ┌─────────┐                                                               │
│   │  User   │  "현재 3개의 이슈가 있습니다: ABC-1, ABC-2, ABC-3"            │
│   └─────────┘                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

> 📌 각 단계의 상세 내용은 해당 문서를 참조하세요:
> - 인증/인가, Internal/External 분기: [6.인증권한](./6.인증권한.md)
> - 상태관리, 헬스체크, 로깅: [7.운영](./7.운영.md)
> - Rate Limit, 동시성 처리: [8.동기비동기](./8.동기비동기.md)
> - 에러 처리 원칙: [5.에러처리](./5.에러처리.md)

---

## 4.3 MCP 프로토콜 메서드별 게이트웨이 대응

| 메서드 | 설명 | 게이트웨이에서 해야 할 일 |
|--------|------|---------------------------|
| `initialize` | 연결 초기화 | 서버 정보를 Hub 정보로 래핑 ( **Capabilities 병합** 이 필요함) |
| `tools/list` | 도구 목록 조회 | 권한 기반 필터링 (Pre-filter) ( **네임스페이스 접두어 추가** 가 필요함) |
| `tools/call` | 도구 실행 | 인증/인가 확인, 헤더 주입, 로깅 (  **접두어 제거 후 라우팅**  이 필요함) |
| `resources/list` | 리소스 목록 | 접근 권한 필터링 |
| `resources/read` | 리소스 조회 | 권한 확인, 민감정보 마스킹 |
| `prompts/list` | 프롬프트 목록 | 그대로 전달 |
| `prompts/get` | 프롬프트 상세 | 그대로 전달 |

---

[다음: 에러처리 →](./5.에러처리.md)
